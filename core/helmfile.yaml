repositories:
  - name: cnpg
    url: https://cloudnative-pg.github.io/charts
  - name: jetstack
    url: https://charts.jetstack.io
  - name: bitnami
    url: "https://charts.bitnami.com/bitnami"
  - name: ingress-nginx
    url: "https://kubernetes.github.io/ingress-nginx"
  - name: openebs
    url: "https://openebs.github.io/openebs"
  - name: nfs-ganesha-server-and-external-provisioner
    url: https://kubernetes-sigs.github.io/nfs-ganesha-server-and-external-provisioner/

releases:
  - name: csi-driver-nfs
    namespace: kube-system
    installed: false
    chart: csi-driver-nfs/csi-driver-nfs
    version: 4.10.0
    values:
      - controller:
          dnsPolicy: ClusterFirstWithHostNet
          runOnControlPlane: true
          replicas: 1
      - storageClass:
          create: true
          name: nfs-csi
          parameters:
            server: nfs-ganesha-nfs-server-provisioner.nfs-server.svc.cluster.local
            share: /
          reclaimPolicy: Delete
          volumeBindingMode: Immediate
          mountOptions:
            - nfsvers=4.1

  - name: openebs
    namespace: openebs
    chart: openebs/openebs
    version: 4.1.3
    wait: true
    values:
      - mayastor:
          etcd:
            localpvScConfig:
              basePath: "/var/openebs/local/localpv-hostpath/etcd"
          loki-stack:
            localpvScConfig:
              basePath: /var/openebs/local/localpv-hostpath/loki
          csi:
            node:
              initContainers:
                enabled: false
      - engines:
          local:
            lvm:
              enabled: false
            zfs:
              enabled: false

  - name: nfs-ganesha
    namespace: nfs-server
    chart: nfs-ganesha-server-and-external-provisioner/nfs-server-provisioner
    version: 1.8.0
    values:
      - image:
          repository: devxygmbh/nfs-server-provisioner
          tag: 6.3
      - persistence:
          enabled: true
          storageClass: openebs-hostpath
          size: 50G
      - storageClass:
          mountOptions:
            - vers=4.1
      - nodeSelector:
          role: nfs-server
    needs:
      - openebs/openebs

  - name: metallb
    namespace: metallb-system
    chart: bitnami/metallb
    version: 6.4.3
    hooks:
    - events: ["prepare"]
      command: "kubectl"
      args: ["apply", "-f", "./metallb-ns.yaml"]
    values:
      - speaker:
         secretName: memberlist

  - name: nginx
    namespace: nginx-system
    chart: ingress-nginx/ingress-nginx
    version: 4.11.0
    values:
      - controller:
          allowSnippetAnnotations: true
    needs:
      - metallb-system/metallb

  - name: cloudnative-pg
    namespace: cnpg-system
    chart: cnpg/cloudnative-pg
    version: 0.23.0

  - name: cert-manager
    namespace: cert-manager
    chart: jetstack/cert-manager
    version: 1.16.3
    wait: true
    set:
      - name: crds.enabled
        value: true
      - name: extraArgs
        values:
          - "--enable-certificate-owner-ref=true"
          - "--dns01-recursive-nameservers-only"
          - "--dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53"

  - name: cloudflare-cluster-issuer
    chart: ./cloudflare-cluster-issuer
    values:
      - ./values.yaml
    secrets:
      - ./secrets.enc.yaml
    needs:
      - cert-manager/cert-manager
