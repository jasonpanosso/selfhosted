---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: cleanup-controller
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
  name: kyverno:cleanup-controller:replicaset
rules:
  - apiGroups:
      - "apps"
    resources:
      - replicasets
    verbs:
      - get
      - watch
      - list
      - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kyverno:cleanup-controller:replicaset
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kyverno:cleanup-controller:replicaset
subjects:
  - kind: ServiceAccount
    name: kyverno-cleanup-controller
    namespace: kyverno
---
apiVersion: kyverno.io/v2
kind: ClusterCleanupPolicy
metadata:
  name: cleanup-empty-replicasets
  namespace: kyverno
spec:
  match:
    any:
      - resources:
          kinds:
            - ReplicaSet
  exclude:
    any:
      - resources:
          namespaces:
            - kube-system
  conditions:
    all:
      - key: "{{ target.spec.replicas }}"
        operator: Equals
        value: 0
      - key: "{{ time_diff('{{target.metadata.creationTimestamp}}','{{ time_now_utc() }}') }}"
        operator: GreaterThan
        value: "0h0m30s"
  schedule: "*/1 * * * *"
