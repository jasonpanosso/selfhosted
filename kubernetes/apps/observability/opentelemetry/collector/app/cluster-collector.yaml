---
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: cluster-collector
spec:
  mode: deployment
  serviceAccount: otel-collector-opentelemetry-collector
  replicas: 1
  config:
    exporters:
      debug: {}
      otlp:
        endpoint: gateway-collector.observability.svc.cluster.local:4317

    processors:
      batch:
        send_batch_max_size: 1500
        send_batch_size: 1000
        timeout: 1s
      resourcedetection/env:
        detectors:
          - env
        override: false
        timeout: 2s

    receivers:
      k8s_cluster:
        auth_type: serviceAccount
        collection_interval: 10s
        k8s_leader_elector: k8s_leader_elector
        allocatable_types_to_report:
          - cpu
          - memory
          - storage
        node_conditions_to_report:
          - Ready
          - MemoryPressure
          - DiskPressure
          - NetworkUnavailable
      k8sobjects:
        k8s_leader_elector: k8s_leader_elector
        auth_type: serviceAccount
        objects:
          - name: events
            group: events.k8s.io
            mode: watch
            exclude_watch_type:
              - DELETED

    service:
      pipelines:
        logs:
          processors:
            - k8sattributes
            - resourcedetection/env
            - batch
          receivers:
            - k8sobjects
          exporters:
            - debug
            - otlp
        metrics:
          receivers:
            - k8s_cluster
          processors:
            - k8sattributes
            - resourcedetection/env
            - batch
          exporters:
            - debug
            - otlp
