---
container_runtime: containerd
secrets:
  externalSecret:
    name: crowdsec
    csLapiSecretKey: CROWDSEC_LAPI_TOKEN
    registrationTokenKey: CROWDSEC_REGISTRATION_TOKEN

agent:
  isDeployment: true
  hostVarLog: false
  additionalAcquisition:
    - source: loki
      log_level: info
      url: http://loki.observability.svc.cluster.local:3100
      limit: 1000
      query: |
        {service_name="traefik"}
      labels:
        type: apache2
  env:
    - name: COLLECTIONS
      value: "crowdsecurity/traefik"
  deploymentAnnotations:
    reloader.stakater.com/auto: "true"
  resources:
    limits:
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 512Mi

lapi:
  deployAnnotations:
    reloader.stakater.com/auto: "true"
  dashboard:
    enabled: false
  env:
    - name: DISABLE_ONLINE_API
      value: "true"
  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 256Mi
  persistentVolume:
    data:
      enabled: true
      accessModes:
        - ReadWriteOnce
      storageClassName: rook-ceph-block
      size: 1Gi
    config:
      enabled: true
      accessModes:
        - ReadWriteOnce
      storageClassName: rook-ceph-block
      size: 100Mi

config:
  parsers:
    geoip.yaml: |
      name: crowdsecurity/geoip-enrich
      description: "Populate event with geoloc info : as, country, coords, source range."
      filter: |
        let ipv6Check = IsIPV6(evt.Meta.source_ip);
        "source_ip" in evt.Meta &&
        (
          not ipv6Check &&
          not (IpInRange(evt.Meta.source_ip, "127.0.0.0/8") || IpInRange(evt.Meta.source_ip, "192.168.0.0/16") || IpInRange(evt.Meta.source_ip, "172.16.0.0/12") || IpInRange(evt.Meta.source_ip, "10.0.0.0/8"))
        ) ||
        (
          ipv6Check &&
          not (IpInRange(evt.Meta.source_ip, "::1/128") || IpInRange(evt.Meta.source_ip, "fd00::/8") || IpInRange(evt.Meta.source_ip, "fc00::/7"))
        )
      data:
        - source_url: https://hub-data.crowdsec.net/mmdb_update/GeoLite2-City.mmdb
          dest_file: GeoLite2-City.mmdb
        - source_url: https://hub-data.crowdsec.net/mmdb_update/GeoLite2-ASN.mmdb
          dest_file: GeoLite2-ASN.mmdb
      statics:
        - method: GeoIpCity
          expression: evt.Meta.source_ip
        - meta: IsoCode
          expression: evt.Enriched.IsoCode
        - meta: IsInEU
          expression: evt.Enriched.IsInEU
        - meta: GeoCoords
          expression: evt.Enriched.GeoCoords
        - method: GeoIpASN
          expression: evt.Meta.source_ip
        - meta: ASNNumber
          expression: evt.Enriched.ASNNumber
        - meta: ASNOrg
          expression: evt.Enriched.ASNOrg
        - method: IpToRange
          expression: evt.Meta.source_ip
        - meta: SourceRange
          expression: evt.Enriched.SourceRange
  config.yaml.local: |
    api:
      server:
        auto_registration:
          enabled: true
          token: "$${REGISTRATION_TOKEN}"
          allowed_ranges:
            - "127.0.0.1/32"
            - "192.168.20.0/24"
            - "10.96.0.0/16"
            - "10.244.0.0/16"
