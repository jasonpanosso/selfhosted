apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{.Values.pgcluster.name}}
spec:
  instances: {{.Values.pgcluster.instances}}
  storage:
    size: {{.Values.pgcluster.size}}
    storageClass: {{.Values.pgcluster.storageClass}}
  bootstrap:
    initdb:
      postInitSQLRefs:
        secretRefs:
          - name: {{.Chart.Name}}
            key: secret.sql
      # jank, this runs after postInitSQL.
      # need to separate as SQLRefs runs in a transaction, and postgres doesn't
      # allow create db in a transaction
      postInitApplicationSQL:
        - CREATE DATABASE {{.Values.radarr.db.mainDB}} OWNER {{.Values.radarr.db.user}};
        - CREATE DATABASE {{.Values.radarr.db.logDB}} OWNER {{.Values.radarr.db.user}};
        - GRANT ALL PRIVILEGES ON DATABASE {{.Values.radarr.db.mainDB}} TO {{.Values.radarr.db.user}};
        - GRANT ALL PRIVILEGES ON DATABASE {{.Values.radarr.db.logDB}} TO {{.Values.radarr.db.user}};

        - CREATE DATABASE {{.Values.sonarr.db.mainDB}} OWNER {{.Values.sonarr.db.user}};
        - CREATE DATABASE {{.Values.sonarr.db.logDB}} OWNER {{.Values.sonarr.db.user}};
        - GRANT ALL PRIVILEGES ON DATABASE {{.Values.sonarr.db.mainDB}} TO {{.Values.sonarr.db.user}};
        - GRANT ALL PRIVILEGES ON DATABASE {{.Values.sonarr.db.logDB}} TO {{.Values.sonarr.db.user}};

        - CREATE DATABASE {{.Values.prowlarr.db.mainDB}} OWNER {{.Values.prowlarr.db.user}};
        - CREATE DATABASE {{.Values.prowlarr.db.logDB}} OWNER {{.Values.prowlarr.db.user}};
        - GRANT ALL PRIVILEGES ON DATABASE {{.Values.prowlarr.db.mainDB}} TO {{.Values.prowlarr.db.user}};
        - GRANT ALL PRIVILEGES ON DATABASE {{.Values.prowlarr.db.logDB}} TO {{.Values.prowlarr.db.user}};
